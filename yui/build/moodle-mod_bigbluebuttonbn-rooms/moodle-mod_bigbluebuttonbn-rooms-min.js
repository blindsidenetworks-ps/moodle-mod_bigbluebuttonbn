YUI.add("moodle-mod_bigbluebuttonbn-rooms",function(i,t){M.mod_bigbluebuttonbn=M.mod_bigbluebuttonbn||{},M.mod_bigbluebuttonbn.rooms={datasource:null,bigbluebuttonbn:{},panel:null,pinginterval:null,init:function(t){this.datasource=new i.DataSource.Get({source:M.cfg.wwwroot+"/mod/bigbluebuttonbn/bbb_ajax.php?sesskey="+M.cfg.sesskey+"&"}),this.bigbluebuttonbn=t,this.pinginterval=t.ping_interval,0===this.pinginterval&&(this.pinginterval=1e4),-1==this.bigbluebuttonbn.profile_features.indexOf("all")&&-1==this.bigbluebuttonbn.profile_features.indexOf("showroom")||this.initRoom(),this.initCompletionValidate()},initRoom:function(){var t;if("open"!==this.bigbluebuttonbn.activity)return t=[M.util.get_string("view_message_conference_has_ended","bigbluebuttonbn")],"ended"!==this.bigbluebuttonbn.activity&&(t=[M.util.get_string("view_message_conference_not_started","bigbluebuttonbn"),this.bigbluebuttonbn.opening,this.bigbluebuttonbn.closing]),void i.DOM.addHTML(i.one("#status_bar"),this.initStatusBar(t));this.updateRoom()},updateRoom:function(t){var t=void 0!==t&&t?"true":"false",n=this.bigbluebuttonbn.meetingid,e=this.bigbluebuttonbn.bigbluebuttonbnid;this.datasource.sendRequest({request:"action=meeting_info&id="+n+"&bigbluebuttonbn="+e+"&updatecache="+t,callback:{success:function(t){i.DOM.addHTML(i.one("#status_bar"),M.mod_bigbluebuttonbn.rooms.initStatusBar(t.data.status.message)),i.DOM.addHTML(i.one("#control_panel"),M.mod_bigbluebuttonbn.rooms.initControlPanel(t.data)),"undefined"!=typeof t.data.status.can_join&&i.DOM.addHTML(i.one("#join_button"),M.mod_bigbluebuttonbn.rooms.initJoinButton(t.data.status)),"undefined"!=typeof t.data.status.can_end&&t.data.status.can_end&&i.DOM.addHTML(i.one("#end_button"),M.mod_bigbluebuttonbn.rooms.initEndButton(t.data.status)),t.data.status.can_join||M.mod_bigbluebuttonbn.rooms.waitModerator({id:n,bnid:e})}}})},initStatusBar:function(t){var n,e,o=i.DOM.create('<span id="status_bar_span">');if(t.constructor!==Array)return i.DOM.setText(o,t),o;for(n in t)t.hasOwnProperty(n)&&(e=i.DOM.create('<span id="status_bar_span_span">'),i.DOM.setText(e,t[n]),i.DOM.addHTML(o,e),i.DOM.addHTML(o,i.DOM.create("<br>")));return o},initControlPanel:function(t){var n,e=i.DOM.create("<div>");return i.DOM.setAttribute(e,"id","control_panel_div"),n="",t.running&&(n=(n+=this.msgStartedAt(t.info.startTime)+" ")+this.msgAttendeesIn(t.info.moderatorCount,t.info.participantCount)),i.DOM.addHTML(e,n),e},msgStartedAt:function(t){var t=parseInt(t,10)-parseInt(t,10)%1e3,t=new Date(t),n=t.getHours(),t=t.getMinutes(),e=M.util.get_string("view_message_session_started_at","bigbluebuttonbn");return e+" <b>"+n+":"+(t<10?"0":"")+t+"</b>."},msgModeratorsIn:function(t){var n=M.util.get_string("view_message_moderators","bigbluebuttonbn");return n=1==t?M.util.get_string("view_message_moderator","bigbluebuttonbn"):n},msgViewersIn:function(t){var n=M.util.get_string("view_message_viewers","bigbluebuttonbn");return n=1==t?M.util.get_string("view_message_viewer","bigbluebuttonbn"):n},msgAttendeesIn:function(t,n){var e,o,i,b;return this.hasParticipants(n)?(e=this.msgModeratorsIn(t),i=this.msgViewersIn(o=n-t),b=M.util.get_string("view_message_session_has_users","bigbluebuttonbn"),1<n?b+" <b>"+t+"</b> "+e+" "+M.util.get_string("view_message_and","bigbluebuttonbn")+" <b>"+o+"</b> "+i+".":(b=M.util.get_string("view_message_session_has_user","bigbluebuttonbn"),0<t?b+" <b>1</b> "+e+".":b+" <b>1</b> "+i+".")):M.util.get_string("view_message_session_no_users","bigbluebuttonbn")+"."},hasParticipants:function(t){return void 0!==t&&0<t},initJoinButton:function(t){var n,e=i.DOM.create("<input>");return i.DOM.setAttribute(e,"id","join_button_input"),i.DOM.setAttribute(e,"type","button"),i.DOM.setAttribute(e,"value",t.join_button_text),i.DOM.setAttribute(e,"class","btn btn-primary"),n="M.mod_bigbluebuttonbn.rooms.join('"+t.join_url+"');",i.DOM.setAttribute(e,"onclick",n),t.can_join||(i.DOM.setAttribute(e,"disabled",!0),n=i.one("#status_bar_span"),t=i.DOM.create("<img>"),i.DOM.setAttribute(t,"id","spinning_wheel"),i.DOM.setAttribute(t,"src","pix/i/processing16.gif"),i.DOM.addHTML(n,"&nbsp;"),i.DOM.addHTML(n,t)),e},initEndButton:function(t){var n=i.DOM.create("<input>");return i.DOM.setAttribute(n,"id","end_button_input"),i.DOM.setAttribute(n,"type","button"),i.DOM.setAttribute(n,"value",t.end_button_text),i.DOM.setAttribute(n,"class","btn btn-secondary"),t.can_end&&i.DOM.setAttribute(n,"onclick","M.mod_bigbluebuttonbn.broker.endMeeting();"),n},endMeeting:function(){i.one("#control_panel_div").remove(),i.one("#join_button").hide(),i.one("#end_button").hide()},remoteUpdate:function(t){setTimeout(function(){M.mod_bigbluebuttonbn.rooms.cleanRoom(),M.mod_bigbluebuttonbn.rooms.updateRoom(!0)},t)},cleanRoom:function(){i.one("#status_bar_span").remove(),i.one("#control_panel_div").remove(),i.one("#join_button").setContent(""),i.one("#end_button").setContent("")},windowClose:function(){window.onunload=function(){opener.M.mod_bigbluebuttonbn.rooms.remoteUpdate(5e3)},window.close()},waitModerator:function(n){var e=setInterval(function(){M.mod_bigbluebuttonbn.rooms.datasource.sendRequest({request:"action=meeting_info&id="+n.id+"&bigbluebuttonbn="+n.bnid,callback:{success:function(t){t.data.running&&(M.mod_bigbluebuttonbn.rooms.cleanRoom(),M.mod_bigbluebuttonbn.rooms.updateRoom(),clearInterval(e))},failure:function(t){n.message=t.error.message}}})},this.pinginterval)},join:function(t){M.mod_bigbluebuttonbn.broker.joinRedirect(t),setTimeout(function(){M.mod_bigbluebuttonbn.rooms.cleanRoom(),M.mod_bigbluebuttonbn.rooms.updateRoom(!0)},15e3)},initCompletionValidate:function(){var t,n=i.one("a[href*=completion_validate]");n&&(t=n.get("hash").substr(1),n.on("click",function(){M.mod_bigbluebuttonbn.broker.completionValidate(t)}))}}},"@VERSION@",{requires:["base","node","datasource-get","datasource-jsonschema","datasource-polling","moodle-core-notification"]});