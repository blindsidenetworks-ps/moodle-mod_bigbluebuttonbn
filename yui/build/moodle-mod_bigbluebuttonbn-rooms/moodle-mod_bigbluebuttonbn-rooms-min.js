YUI.add("moodle-mod_bigbluebuttonbn-rooms",function(s,t){M.mod_bigbluebuttonbn=M.mod_bigbluebuttonbn||{},M.mod_bigbluebuttonbn.rooms={datasource:null,bigbluebuttonbn:{},panel:null,pinginterval:null,init:function(t){this.datasource=new s.DataSource.Get({source:M.cfg.wwwroot+"/mod/bigbluebuttonbn/bbb_ajax.php?sesskey="+M.cfg.sesskey+"&"}),this.bigbluebuttonbn=t,this.pinginterval=t.ping_interval,0===this.pinginterval&&(this.pinginterval=1e4),-1==this.bigbluebuttonbn.profile_features.indexOf("all")&&-1==this.bigbluebuttonbn.profile_features.indexOf("showroom")||(this.initRoom(),this.initGuestLink()),this.initCompletionValidate()},initRoom:function(){if("open"!==this.bigbluebuttonbn.activity){var t=[M.util.get_string("view_message_conference_has_ended","bigbluebuttonbn")];return"ended"!==this.bigbluebuttonbn.activity&&(t=[M.util.get_string("view_message_conference_not_started","bigbluebuttonbn"),this.bigbluebuttonbn.opening,this.bigbluebuttonbn.closing]),void s.DOM.addHTML(s.one("#status_bar"),this.initStatusBar(t))}this.updateRoom()},initGuestLink:function(){var t,e=this.bigbluebuttonbn.guestlink,n=this.datasource,i=this.bigbluebuttonbn.bigbluebuttonbnid,o=document.getElementById("id_guestlinkurl_copy");o&&(o.onclick=function(){var t=document.getElementById("id_guestlinkurl");t.select(),t.setSelectionRange(0,99999),document.execCommand("copy")}),(o=document.getElementById("id_password_copy"))&&(o.onclick=function(){var t=document.getElementById("id_password");t.value&&!isNaN(t.value)&&(t.select(),t.setSelectionRange(0,6),document.execCommand("copy"))}),e.changepassenabled&&(t=function(t){n.sendRequest({request:"action=generate_guest_password&bigbluebuttonbn="+i+"&delete="+t,callback:{success:function(o){require(["core/notification"],function(t){var e,n=document.getElementById("id_password"),i=o.data;i&&(n.value=("000000"+i).slice(-6)),e=M.util.get_string("view_guestlink_update_access_code","bigbluebuttonbn",'<b class="notification_access_code">'+n.value+"</b>"),$("#user-notifications .notification_access_code").each(function(){$(this).closest(".alert").remove()}),t.addNotification({message:e,type:"info"})})}}})},(o=document.getElementById("id_password_clear"))&&o.addEventListener("click",function(){document.getElementById("id_password").value=null}),(o=document.getElementById("id_password_change"))&&o.addEventListener("click",function(){t(!1)}))},updateRoom:function(t){var e,n,i="false";void 0!==t&&t&&(i="true"),e=this.bigbluebuttonbn.meetingid,n=this.bigbluebuttonbn.bigbluebuttonbnid,this.datasource.sendRequest({request:"action=meeting_info&id="+e+"&bigbluebuttonbn="+n+"&updatecache="+i,callback:{success:function(t){s.DOM.addHTML(s.one("#status_bar"),M.mod_bigbluebuttonbn.rooms.initStatusBar(t.data.status.message)),s.DOM.addHTML(s.one("#control_panel"),M.mod_bigbluebuttonbn.rooms.initControlPanel(t.data)),"undefined"!=typeof t.data.status.can_join&&s.DOM.addHTML(s.one("#join_button"),M.mod_bigbluebuttonbn.rooms.initJoinButton(t.data.status)),"undefined"!=typeof t.data.status.can_end&&t.data.status.can_end&&s.DOM.addHTML(s.one("#end_button"),M.mod_bigbluebuttonbn.rooms.initEndButton(t.data.status)),t.data.status.can_join||M.mod_bigbluebuttonbn.rooms.waitModerator({id:e,bnid:n})}}})},initStatusBar:function(t){var e,n,i=s.DOM.create('<span id="status_bar_span">');if(t.constructor!==Array)return s.DOM.setText(i,t),i;for(e in t)t.hasOwnProperty(e)&&(n=s.DOM.create('<span id="status_bar_span_span">'),s.DOM.setText(n,t[e]),s.DOM.addHTML(i,n),s.DOM.addHTML(i,s.DOM.create("<br>")));return i},initControlPanel:function(t){var e,n=s.DOM.create("<div>");return s.DOM.setAttribute(n,"id","control_panel_div"),e="",t.running&&(e+=this.msgStartedAt(t.info.startTime)+" ",e+=this.msgAttendeesIn(t.info.moderatorCount,t.info.participantCount)),s.DOM.addHTML(n,e),n},msgStartedAt:function(t){var e=parseInt(t,10)-parseInt(t,10)%1e3,n=new Date(e),i=n.getHours(),o=n.getMinutes(),s=M.util.get_string("view_message_session_started_at","bigbluebuttonbn");return s+" <b>"+i+":"+(o<10?"0":"")+o+"</b>."},msgModeratorsIn:function(t){var e=M.util.get_string("view_message_moderators","bigbluebuttonbn");return 1==t&&(e=M.util.get_string("view_message_moderator","bigbluebuttonbn")),e},msgViewersIn:function(t){var e=M.util.get_string("view_message_viewers","bigbluebuttonbn");return 1==t&&(e=M.util.get_string("view_message_viewer","bigbluebuttonbn")),e},msgAttendeesIn:function(t,e){var n,i,o,s;return this.hasParticipants(e)?(n=this.msgModeratorsIn(t),i=e-t,o=this.msgViewersIn(i),s=M.util.get_string("view_message_session_has_users","bigbluebuttonbn"),1<e?s+" <b>"+t+"</b> "+n+" "+M.util.get_string("view_message_and","bigbluebuttonbn")+" <b>"+i+"</b> "+o+".":(s=M.util.get_string("view_message_session_has_user","bigbluebuttonbn"),0<t?s+" <b>1</b> "+n+".":s+" <b>1</b> "+o+".")):M.util.get_string("view_message_session_no_users","bigbluebuttonbn")+"."},hasParticipants:function(t){return void 0!==t&&0<t},initJoinButton:function(t){var e,n,i,o=s.DOM.create("<input>");return s.DOM.setAttribute(o,"id","join_button_input"),s.DOM.setAttribute(o,"type","button"),s.DOM.setAttribute(o,"value",t.join_button_text),s.DOM.setAttribute(o,"class","btn btn-primary"),e=this.bigbluebuttonbn.accesspolicy?'$("#policymodal").modal("show");':"M.mod_bigbluebuttonbn.rooms.join('"+t.join_url+"');",s.DOM.setAttribute(o,"onclick",e),t.can_join||(s.DOM.setAttribute(o,"disabled",!0),n=s.one("#status_bar_span"),i=s.DOM.create("<img>"),s.DOM.setAttribute(i,"id","spinning_wheel"),s.DOM.setAttribute(i,"src","pix/i/processing16.gif"),s.DOM.addHTML(n,"&nbsp;"),s.DOM.addHTML(n,i)),o},initEndButton:function(t){var e=s.DOM.create("<input>");return s.DOM.setAttribute(e,"id","end_button_input"),s.DOM.setAttribute(e,"type","button"),s.DOM.setAttribute(e,"value",t.end_button_text),s.DOM.setAttribute(e,"class","btn btn-secondary"),t.can_end&&s.DOM.setAttribute(e,"onclick","M.mod_bigbluebuttonbn.broker.endMeeting();"),e},endMeeting:function(){s.one("#control_panel_div").remove(),
s.one("#join_button").hide(),s.one("#end_button").hide()},remoteUpdate:function(t){setTimeout(function(){M.mod_bigbluebuttonbn.rooms.cleanRoom(),M.mod_bigbluebuttonbn.rooms.updateRoom(!0)},t)},cleanRoom:function(){s.one("#status_bar_span").remove(),s.one("#control_panel_div").remove(),s.one("#join_button").setContent(""),s.one("#end_button").setContent("")},windowClose:function(){window.onunload=function(){opener.M.mod_bigbluebuttonbn.rooms.remoteUpdate(5e3)},window.close()},waitModerator:function(e){var n=setInterval(function(){M.mod_bigbluebuttonbn.rooms.datasource.sendRequest({request:"action=meeting_info&id="+e.id+"&bigbluebuttonbn="+e.bnid,callback:{success:function(t){if(t.data.running)return M.mod_bigbluebuttonbn.rooms.cleanRoom(),M.mod_bigbluebuttonbn.rooms.updateRoom(),void clearInterval(n)},failure:function(t){e.message=t.error.message}}})},this.pinginterval)},join:function(t){M.mod_bigbluebuttonbn.broker.joinRedirect(t),setTimeout(function(){M.mod_bigbluebuttonbn.rooms.cleanRoom(),M.mod_bigbluebuttonbn.rooms.updateRoom(!0)},15e3)},initCompletionValidate:function(){var t,e=s.one("a[href*=completion_validate]");e&&(t=e.get("hash").substr(1),e.on("click",function(){M.mod_bigbluebuttonbn.broker.completionValidate(t)}))}}},"@VERSION@",{requires:["base","node","datasource-get","datasource-jsonschema","datasource-polling","moodle-core-notification"]});