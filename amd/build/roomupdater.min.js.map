{"version":3,"file":"roomupdater.min.js","sources":["../src/roomupdater.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * JS room updater.\r\n *\r\n * @module      mod_bigbluebuttonbn/roomupdater\r\n * @copyright   2021 Blindside Networks Inc\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Templates from \"core/templates\";\r\nimport {exception as displayException} from 'core/notification';\r\nimport {getMeetingInfo} from './repository';\r\n\r\nconst timeout = 5000;\r\nconst maxFactor = 10;\r\n\r\nlet updateCount = 0;\r\nlet updateFactor = 1;\r\nlet timerReference = null;\r\nlet timerRunning = false;\r\n\r\nconst resetValues = () => {\r\n    updateCount = 0;\r\n    updateFactor = 1;\r\n};\r\n\r\n/**\r\n * Start the information poller.\r\n */\r\nexport const start = () => {\r\n    timerRunning = true;\r\n    timerReference = setTimeout(() => poll(), timeout);\r\n};\r\n\r\n/**\r\n * Stop the room updater.\r\n */\r\nexport const stop = () => {\r\n    timerRunning = false;\r\n    if (timerReference) {\r\n        clearInterval(timerReference);\r\n        timerReference = null;\r\n    }\r\n\r\n    resetValues();\r\n};\r\n\r\nconst poll = () => {\r\n    if (!timerRunning) {\r\n        // The poller has been stopped.\r\n        return;\r\n    }\r\n    if ((updateCount % updateFactor) === 0) {\r\n        updateRoom()\r\n        .then(() => {\r\n            if (updateFactor >= maxFactor) {\r\n                updateFactor = 1;\r\n            } else {\r\n                updateFactor++;\r\n            }\r\n\r\n            return;\r\n\r\n        })\r\n        .catch()\r\n        .then(() => {\r\n            timerReference = setTimeout(() => poll(), timeout);\r\n            return;\r\n        })\r\n        .catch();\r\n    }\r\n};\r\n\r\n/**\r\n * Update the room information.\r\n *\r\n * @param {boolean} [updatecache=false]\r\n * @returns {Promise}\r\n */\r\nexport const updateRoom = (updatecache = false) => {\r\n    const bbbRoomViewElement = document.getElementById('bbb-room-view');\r\n    const bbbId = bbbRoomViewElement.dataset.bbbId;\r\n    const groupId = bbbRoomViewElement.dataset.groupId;\r\n    return getMeetingInfo(bbbId, groupId, updatecache)\r\n        .then(data => {\r\n            // Just make sure we have the right information for the template.\r\n            data.haspresentations = false;\r\n            if (data.presentations && data.presentations.length) {\r\n                data.haspresentations = true;\r\n            }\r\n            return Templates.renderForPromise('mod_bigbluebuttonbn/room_view', data);\r\n        })\r\n        .then(({html, js}) => Templates.replaceNodeContents(bbbRoomViewElement, html, js))\r\n        .catch(displayException);\r\n};\r\n"],"names":["updateCount","updateFactor","timerReference","timerRunning","setTimeout","poll","clearInterval","updateRoom","then","catch","updatecache","bbbRoomViewElement","document","getElementById","bbbId","dataset","groupId","data","haspresentations","presentations","length","Templates","renderForPromise","html","js","replaceNodeContents","displayException"],"mappings":";;;;;;;uLA8BIA,YAAc,EACdC,aAAe,EACfC,eAAiB,KACjBC,cAAe,iBAUE,WACjBA,cAAe,EACfD,eAAiBE,YAAW,kBAAMC,SAlBtB,oBAwBI,WAChBF,cAAe,EACXD,iBACAI,cAAcJ,gBACdA,eAAiB,MAnBrBF,YAAc,EACdC,aAAe,OAwBbI,KAAO,SAAPA,OACGF,cAIAH,YAAcC,cAAkB,GACjCM,aACCC,MAAK,WACEP,cAzCE,GA0CFA,aAAe,EAEfA,kBAMPQ,QACAD,MAAK,WACFN,eAAiBE,YAAW,kBAAMC,SArD9B,QAwDPI,SAUIF,WAAa,eAACG,oEACjBC,mBAAqBC,SAASC,eAAe,iBAC7CC,MAAQH,mBAAmBI,QAAQD,MACnCE,QAAUL,mBAAmBI,QAAQC,eACpC,8BAAeF,MAAOE,QAASN,aACjCF,MAAK,SAAAS,aAEFA,KAAKC,kBAAmB,EACpBD,KAAKE,eAAiBF,KAAKE,cAAcC,SACzCH,KAAKC,kBAAmB,GAErBG,mBAAUC,iBAAiB,gCAAiCL,SAEtET,MAAK,mBAAEe,UAAAA,KAAMC,QAAAA,UAAQH,mBAAUI,oBAAoBd,mBAAoBY,KAAMC,OAC7Ef,MAAMiB"}